

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>8.2.1. MQTT &mdash; OhStem Product Documents 0.0.2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="8.2.2. Yeelight" href="yeelight.html" />
    <link rel="prev" title="8. Internet of Things" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../../index.html">
          

          
            
            <img src="../../../_static/logo-ohstem.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../board/index.html">xController Board</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">xController Micropython Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../basics/index.html">Basic Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Advance Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../random.html">1. Random Number</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem.html">2. Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timer.html">3. Timer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../radio.html">4. Radio Broadcast</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c.html">5. I2C</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thread.html">6. Thread</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bme280.html">7. BME280</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">8. Internet of Things</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.html#iot-basics">8.1. IoT basics</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html#iot-tutorial">8.2. IoT tutorial</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">8.2.1. MQTT</a></li>
<li class="toctree-l4"><a class="reference internal" href="yeelight.html">8.2.2. Yeelight</a></li>
<li class="toctree-l4"><a class="reference internal" href="bigiot.html">8.2.3. BIGIOT</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">xController Arduino Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../basics/index.html">Basic Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Advance Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../random.html">1. Random Number</a></li>
<li class="toctree-l2"><a class="reference internal" href="../filesystem.html">2. Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timer.html">3. Timer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../radio.html">4. Radio Broadcast</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c.html">5. I2C</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thread.html">6. Thread</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bme280.html">7. BME280</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">8. Internet of Things</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.html#iot-basics">8.1. IoT basics</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html#iot-tutorial">8.2. IoT tutorial</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">8.2.1. MQTT</a></li>
<li class="toctree-l4"><a class="reference internal" href="yeelight.html">8.2.2. Yeelight</a></li>
<li class="toctree-l4"><a class="reference internal" href="bigiot.html">8.2.3. BIGIOT</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">xController Library</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../library/micropython-api/index.html">MicroPython Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library/arduino-api/index.html">Arduino Library</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">OhStem Product Documents</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Advance Tutorials</a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">8. </span>Internet of Things</a> &raquo;</li>
        
      <li><span class="section-number">8.2.1. </span>MQTT</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/username/reponame/blob/mastertutorials/advance/iot/mqtt.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mqtt">
<h1><span class="section-number">8.2.1. </span>MQTT<a class="headerlink" href="#mqtt" title="Permalink to this headline">¶</a></h1>
<p>MQTT (Message Queue Telemetry Transport), a telemetry transport protocol, provides a subscription/publish mode, which is more simple, lightweight, and easy to use. For restricted environments (low bandwidth, high network delay, unstable network communication), it can be simply summarized as.</p>
<p>MQTT is a “light weight” messaging protocol based on publish-subscribe for use on top of the TCP/IP protocol, it is suitable for connections in remote locations that require “small code footprint” or limited network bandwidth.
A protocol that enables one-to-many communication (people call it publish or subscribe). It consists of 3 functions, namely broker, publisher and subscriber.</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../images/tutorials/IoT/mqtt.png"><img alt="../images/tutorials/IoT/mqtt.png" src="../images/tutorials/IoT/mqtt.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">broker、publisher、subscriber</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>The intermediary assumes the role of a server that forwards MQTT communications. Relatively speaking, publishers and subscribers act as clients. The publisher is the client responsible for sending messages, and the subscriber is the client responsible for receiving messages.
Messages exchanged by MQTT are accompanied by a “subject” address, and each client regards this “subject” as a receiving address, and performs the operation of transmitting messages to it.
Metaphorically, an intermediary is a mailbox that receives mail.</p>
<div class="figure align-default" id="id2">
<img alt="../images/tutorials/IoT/iot_publish.png:align:center:width:600" src="../images/tutorials/IoT/iot_publish.png:align:center:width:600" />
<p class="caption"><span class="caption-text">Mechanism of MQTT communication</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>The intermediary is waiting for each client to connect to it. The subscriber connects to the intermediary and tells the intermediary the name of the topic he wants to subscribe to. This is called a subscription.
Then the publisher connects to the intermediary and sends the message with the subject as the receiving address. This is the release. As soon as the publisher publishes the topic, the intermediary will deliver the message to the subscribers who subscribe to the topic.</p>
<p>As shown in the figure above, if the subscriber subscribes to topic A, the intermediary will only deliver the message to the subscriber if the publisher posts topic A.
Subscribers and intermediaries are always connected, and publishers only need to establish a connection at the time of publication, but to publish several times in a short period of time, you need to stay connected.
Because the intermediary plays the role of forwarding messages, there is no need for each client to know the other party’s IP address and other mail receiving addresses on the network. And because multiple clients can subscribe to the same topic, the publisher and subscriber are in a one-to-many relationship.
In the communication between the device and the server, the device is equivalent to the publisher, and the server is equivalent to the subscriber.</p>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../images/tutorials/IoT/IoT_subscribe.png"><img alt="../images/tutorials/IoT/IoT_subscribe.png" src="../images/tutorials/IoT/IoT_subscribe.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">MQTT theme examples</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>The theme uses a layered structure. Multiple symbols can be specified with symbols like “#” and “+”. As shown in the figure above, the “#” symbol is used in /Sensor/temperature/# , so that all topics starting with /Sensor/temperature/  can be specified.
In addition, the symbol “+” is used in /Sensor/+/room1 , so that you can specify all topics that start with /Sensor/、and end with /room1 .</p>
<p><em>The principle of MQTT is reproduced to [Illustrated Internet of Things/ Japan NTT DATA Group；Ding Ling translation. –北京：人民邮电出版社， 2017.4]</em></p>
<div class="section" id="introduction-to-the-internet-of-things-platform">
<h2><span class="section-number">8.2.1.1. </span>Introduction to the Internet of Things platform<a class="headerlink" href="#introduction-to-the-internet-of-things-platform" title="Permalink to this headline">¶</a></h2>
<p>Announcement - subscribe messaging model requires a message broker server. The proxy server is responsible for distributing messages to interested clients based on the message subject.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>At present, there are various MQTT IoT platforms on the Internet, you can choose the mqtt IoT platform that suits you according to your requirements. I recommend the following relatively good IoT platforms.</p>
</div>
<ul>
<li><p>OneNet China Mobile IoT platform：<a class="reference external" href="https://open.iot.10086.cn/">https://open.iot.10086.cn/</a></p>
<blockquote>
<div><ul class="simple">
<li><p>Advantages: Support multiple communication protocols, such as MQTT, HTTP, etc.；Editable application function, can make page UI for data display and switch control.</p></li>
<li><p>Disadvantages: The platform operation is more complicated, slightly different from the official MQTT, and it is difficult to understand for beginners.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>DFRobot Easy IoT platform：<a class="reference external" href="http://iot.dfrobot.com.cn/">http://iot.dfrobot.com.cn/</a></p>
<blockquote>
<div><ul class="simple">
<li><p>Advantages: simple operation, suitable for beginners to learn.</p></li>
<li><p>Disadvantages: Cannot customize topic; lack of UI interface editing on the application side, unable to present data.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Adafruit IoT platform：<a class="reference external" href="https://io.adafruit.com/">https://io.adafruit.com/</a></p>
<blockquote>
<div><ul class="simple">
<li><p>Advantages: simple operation, suitable for MQTT teaching；There are ample dashboard editing functions, which can present data well；Support IFTTT, can be connected to many Internet services, and play variously.</p></li>
<li><p>Disadvantages: foreign servers, unstable connection, often unable to connect.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>In addition to the above, you can also build an mqtt server yourself.</p>
</div>
<div class="section" id="connect-to-mqtt-proxy-server">
<h2><span class="section-number">8.2.1.2. </span>Connect to MQTT proxy server<a class="headerlink" href="#connect-to-mqtt-proxy-server" title="Permalink to this headline">¶</a></h2>
<p>The following uses Easy IoT to explain how to use MQTT to subscribe to topics and publish messages.</p>
<p>First, import the required modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">umqtt.simple</span> <span class="kn">import</span> <span class="n">MQTTClient</span>    <span class="c1"># import umqtt.simple module for simple MQTT client function.</span>
<span class="kn">from</span> <span class="nn">mpython</span> <span class="kn">import</span> <span class="o">*</span>                  <span class="c1"># import mpython module</span>
</pre></div>
</div>
<p>First, connect the mPython Board to the Internet:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mywifi</span><span class="o">=</span><span class="n">wifi</span><span class="p">()</span>                           <span class="c1"># Instantiate wifi class</span>
<span class="n">mywifi</span><span class="o">.</span><span class="n">connectWiFi</span><span class="p">(</span><span class="s2">&quot;ssid&quot;</span><span class="p">,</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>   <span class="c1"># WiFi connection, ssid is the username, password is the password</span>
</pre></div>
</div>
<p>Example MQTTClient:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">=</span> <span class="s2">&quot;182.254.130.180&quot;</span>       <span class="c1"># Easy IoT MQTT server address</span>
<span class="n">username</span><span class="o">=</span><span class="s1">&#39;yourIotUserName&#39;</span>       <span class="c1"># Iot_id on your Easy IoT</span>
<span class="n">password</span><span class="o">=</span><span class="s1">&#39;yourIotPassword&#39;</span>       <span class="c1"># Iot_pwd on your Easy IoT</span>
<span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s2">&quot;yourClientID&quot;</span>       <span class="c1"># Client ID on your Easy IoT</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">CLIENT_ID</span><span class="p">,</span> <span class="n">SERVER</span><span class="p">,</span><span class="mi">1883</span><span class="p">,</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">)</span>  <span class="c1"># MQTTClient class instance</span>
<span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>         <span class="c1"># mqtt connect</span>
</pre></div>
</div>
<p>MQTTClient(client_id, server, port=0, user=None, password=None, keepalive=0), <code class="docutils literal notranslate"><span class="pre">client_id</span></code> parameter is the unique id of MQTT client； The <code class="docutils literal notranslate"><span class="pre">server</span></code> parameter is for the mqtt proxy server
IP address； The port number of the server accessed by the <code class="docutils literal notranslate"><span class="pre">port</span></code> parameter is mqtt, which is generally 1883, and the port will be different for different platforms；The <code class="docutils literal notranslate"><span class="pre">user</span></code> parameter is the username used to obtain mqtt authentication；The <code class="docutils literal notranslate"><span class="pre">password</span></code> parameter is the password for obtaining MQTT authentication；
The <code class="docutils literal notranslate"><span class="pre">keepalive</span></code> parameter is the connection save time.When there is no subscription or release package within the keepalive interval, the connection will be automatically disconnected.</p>
<a class="reference internal image-reference" href="../images/tutorials/mqtt_1.png"><img alt="../images/tutorials/mqtt_1.png" src="../images/tutorials/mqtt_1.png" /></a>
</div>
<div class="section" id="announcement">
<h2><span class="section-number">8.2.1.3. </span>Announcement<a class="headerlink" href="#announcement" title="Permalink to this headline">¶</a></h2>
<p>Publish the device topic on Easy IoT:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">&quot;Bkgk2zXb4&quot;</span><span class="p">,</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">publish(topic,</span> <span class="pre">msg)</span></code> , <code class="docutils literal notranslate"><span class="pre">topic</span></code> parameter is the published topic. On the management interface of Easy IoT, the devices are distinguished by topic and cannot be modified.；<code class="docutils literal notranslate"><span class="pre">msg</span></code> parameter is the message of the topic；</p>
</div>
<p>After publishing, you can find the message just published in the “View Details” of the device in the Easy IoT workshop, as follows:</p>
<img alt="../images/tutorials/mqtt_2.png" src="../images/tutorials/mqtt_2.png" />
<img alt="../images/tutorials/mqtt_3.png" src="../images/tutorials/mqtt_3.png" />
</div>
<div class="section" id="subscribe-to-topics">
<h2><span class="section-number">8.2.1.4. </span>Subscribe to Topics<a class="headerlink" href="#subscribe-to-topics" title="Permalink to this headline">¶</a></h2>
<p>Set to print out after receiving a message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sub_cb</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">((</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

<span class="n">c</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">sub_cb</span><span class="p">)</span>
</pre></div>
</div>
<p>Before subscribing to the topic, you need to set the callback function <code class="docutils literal notranslate"><span class="pre">set_callback(sub_cb)</span></code>, <code class="docutils literal notranslate"><span class="pre">sub_cb</span></code> is the function to be processed after receiving the message, which must contain two parameters.</p>
<p>Topic subscription, <code class="docutils literal notranslate"><span class="pre">topic</span></code> parameter is the topic to be subscribed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally use <code class="docutils literal notranslate"><span class="pre">wait_msg()</span></code> to wait for the message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">wait_msg</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="remote-lights-switching">
<h3><span class="section-number">8.2.1.4.1. </span>Remote lights switching<a class="headerlink" href="#remote-lights-switching" title="Permalink to this headline">¶</a></h3>
<p>The following example uses the remote control switch light made by the MQTT subscription theme function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">umqtt.simple</span> <span class="kn">import</span> <span class="n">MQTTClient</span>
<span class="kn">from</span> <span class="nn">mpython</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">machine</span> <span class="kn">import</span> <span class="n">Timer</span>

<span class="n">SERVER</span> <span class="o">=</span> <span class="s2">&quot;182.254.130.180&quot;</span>            <span class="c1"># Easy IoT MQTT server address</span>
<span class="n">username</span><span class="o">=</span><span class="s1">&#39;yourIotUserName&#39;</span>            <span class="c1"># Iot_id on your Easy IoT</span>
<span class="n">password</span><span class="o">=</span><span class="s1">&#39;yourIotPassword&#39;</span>            <span class="c1"># Iot_pwd on your Easy IoT</span>
<span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s2">&quot;yourClientID&quot;</span>            <span class="c1"># Client ID on your Easy IoT</span>

<span class="n">TOPIC</span><span class="o">=</span><span class="s1">&#39;yourTopic&#39;</span>                     <span class="c1"># Topic of your device on Easy IoT</span>

<span class="n">mywifi</span><span class="o">=</span><span class="n">wifi</span><span class="p">()</span>                         <span class="c1"># Instantiate WiFi class</span>
<span class="n">mywifi</span><span class="o">.</span><span class="n">connectWiFi</span><span class="p">(</span><span class="s2">&quot;ssid&quot;</span><span class="p">,</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>   <span class="c1"># WiFi connection, ssid is the username, password is the password</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">sub_cb</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>             <span class="c1"># Callback function when a subscription message is received</span>
        <span class="nb">print</span><span class="p">((</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>             <span class="c1"># Print the received topic message</span>

        <span class="k">if</span> <span class="n">topic</span> <span class="o">==</span> <span class="n">TOPIC</span><span class="o">.</span><span class="n">encode</span><span class="p">():</span>     <span class="c1"># If the topic is the topic of our device, received byte type. Here you need to convert TOPIC to byte type.</span>

            <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;on&quot;</span><span class="p">:</span>                <span class="c1"># If the message is &quot;on&quot;, lights turn ON</span>
                    <span class="n">rgb</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                    <span class="n">rgb</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">msg</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;off&quot;</span><span class="p">:</span>         <span class="c1"># If the message is &quot;off&quot;, lights turn OFF</span>
                <span class="n">rgb</span><span class="o">.</span><span class="n">fill</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">rgb</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">CLIENT_ID</span><span class="p">,</span> <span class="n">SERVER</span><span class="p">,</span><span class="mi">1883</span><span class="p">,</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">keepalive</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>   <span class="c1"># MQTTClient class instance, and set the connection hold interval to 30 seconds</span>
    <span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>                             <span class="c1"># mqtt connects</span>
    <span class="n">c</span><span class="o">.</span><span class="n">set_callback</span><span class="p">(</span><span class="n">sub_cb</span><span class="p">)</span>                  <span class="c1"># Set callback function</span>
    <span class="n">c</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">TOPIC</span><span class="p">)</span>                      <span class="c1"># Subscribe to topics</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connected to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">SERVER</span><span class="p">)</span>

    <span class="n">tim1</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                          <span class="c1"># Create Timer 1</span>
    <span class="n">tim1</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">Timer</span><span class="o">.</span><span class="n">PERIODIC</span><span class="p">,</span><span class="n">callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span><span class="n">c</span><span class="o">.</span><span class="n">ping</span><span class="p">())</span>     <span class="c1"># Send PING at 20-second intervals to keep connected</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">wait_msg</span><span class="p">()</span>                    <span class="c1"># Waiting for messages in a loop</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">c</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>                     <span class="c1"># When abnormal, disconnect MQTT</span>
</pre></div>
</div>
<p>Then click on the device “Send Message” to enter the Easy IoT workshop to send the topic message as follows:</p>
<img alt="../images/tutorials/mqtt_4.png" src="../images/tutorials/mqtt_4.png" />
<a class="reference internal image-reference" href="../images/tutorials/mqtt_5.gif"><img alt="../images/tutorials/mqtt_5.gif" src="../images/tutorials/mqtt_5.gif" /></a>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="yeelight.html" class="btn btn-neutral float-right" title="8.2.2. Yeelight" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="8. Internet of Things" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, OHSTEM.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>